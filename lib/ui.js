"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MLab=void 0;const tslib_1=require("tslib"),react_1=tslib_1.__importStar(require("react")),ink_1=require("ink"),ink_spinner_1=tslib_1.__importDefault(require("ink-spinner")),dns=tslib_1.__importStar(require("dns/promises")),TIME_EXPECTED=10,FixedSpacer=({size:t})=>react_1.default.createElement(react_1.default.Fragment,null," ".repeat(t)),ErrorMessage=({text:t})=>react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,{bold:!0,color:"red"},"\u203A",react_1.default.createElement(FixedSpacer,{size:1})),react_1.default.createElement(ink_1.Text,{dimColor:!0},t),react_1.default.createElement(ink_1.Newline,{count:2})),MLab=({speedTest:t,options:u})=>{const o={isDone:!1,downloadSpeed:"0",downloadUnit:"Mb/s",downloadCompleted:!1,downloadProgress:0,uploadSpeed:"0",uploadUnit:"Mb/s",uploadCompleted:!1,uploadProgress:0,latencyUnit:"ms",lossUnit:"%"},[l,n]=(0,react_1.useState)(o),[r,s]=(0,react_1.useState)("");(0,ink_1.useInput)(async(e,a)=>{a.return&&(n(o),await t.stop(),n(o),await t.run())});const{exit:d}=(0,ink_1.useApp)(),{write:i}=(0,ink_1.useStdout)();if((0,react_1.useEffect)(()=>((async()=>{try{await dns.lookup("speed.measurementlab.net")}catch(e){s(e.code==="ENOTFOUND"?"Please check your internet connection":`Something happened ${JSON.stringify(e)}`),d();return}})(),t.on("server-chosen",e=>{n(a=>({...a,isDone:!1,testServer:`${e.location.city}, ${e.location.country}`}))}),t.on("download-start",()=>{n(e=>({...e,isDone:!1,downloadSpeed:"0",downloadUnit:"Mb/s"}))}),t.on("download-measurement",e=>{e.Source==="client"&&n(a=>({...a,downloadSpeed:e.Data.MeanClientMbps.toFixed(2),downloadProgress:e.Data.ElapsedTime>TIME_EXPECTED?1:e.Data.ElapsedTime/TIME_EXPECTED}))}),t.on("download-complete",e=>{n(a=>({...a,downloadSpeed:e.LastClientMeasurement.MeanClientMbps.toFixed(2),downloadProgress:1,downloadCompleted:!0,latency:(e.LastServerMeasurement.TCPInfo.MinRTT/1e3).toFixed(0),loss:(e.LastServerMeasurement.TCPInfo.BytesRetrans/e.LastServerMeasurement.TCPInfo.BytesSent*100).toFixed(2)}))}),t.on("upload-start",()=>{n(e=>({...e,uploadSpeed:"0",uploadUnit:"Mb/s"}))}),t.on("upload-measurement",e=>{e.Source==="server"&&n(a=>({...a,uploadSpeed:(e.Data.TCPInfo.BytesReceived/e.Data.TCPInfo.ElapsedTime*8).toFixed(2)})),e.Source==="client"&&n(a=>({...a,uploadProgress:e.Data.ElapsedTime>TIME_EXPECTED?1:e.Data.ElapsedTime/TIME_EXPECTED}))}),t.on("upload-complete",e=>{n(a=>({...a,uploadSpeed:(e.LastServerMeasurement.TCPInfo.BytesReceived/e.LastServerMeasurement.TCPInfo.ElapsedTime*8).toFixed(2),uploadProgress:1,uploadCompleted:!0}))}),t.on("complete",()=>{n(e=>({...e,isDone:!0}))}),()=>{t.removeAllListeners()}),[d]),r)return react_1.default.createElement(ErrorMessage,{text:r});if(u.json)return i(JSON.stringify(l)),null;const c=l.downloadCompleted?"green":"cyan",m=l.uploadCompleted?"green":"cyan";return react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,"Test Server: ",l.testServer?"\u{1F5A5} "+l.testServer:"-")),react_1.default.createElement(ink_1.Box,null,!l.isDone&&react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:2})),react_1.default.createElement(ink_1.Text,{color:"cyan"},react_1.default.createElement(ink_spinner_1.default,null)),react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:1}))),l.isDone&&react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,{color:c},l.downloadSpeed," ",react_1.default.createElement(ink_1.Text,{dimColor:!0},l.downloadUnit," \u2193")),react_1.default.createElement(ink_1.Text,null," / "),react_1.default.createElement(ink_1.Text,{color:m},l.uploadSpeed," ",react_1.default.createElement(ink_1.Text,{dimColor:!0},l.uploadUnit," \u2191"))),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,"Latency: ",l.latency??"-"," ",l.latencyUnit)),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,"Loss: ",l.loss??"- ",l.lossUnit)))};exports.MLab=MLab;