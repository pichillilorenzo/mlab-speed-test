"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MLab=void 0;const tslib_1=require("tslib"),react_1=tslib_1.__importStar(require("react")),ink_1=require("ink"),ink_spinner_1=tslib_1.__importDefault(require("ink-spinner")),ink_link_1=tslib_1.__importDefault(require("ink-link")),child_process_1=require("child_process"),fs=tslib_1.__importStar(require("fs")),dns=tslib_1.__importStar(require("dns/promises")),TIME_EXPECTED=10,isOffline=async()=>{try{await dns.lookup("speed.measurementlab.net")}catch(l){return l.code==="ENOTFOUND"}return!1},exportSpeedTestResults=l=>{const a={downloadSpeed:l.downloadSpeed,downloadUnit:l.downloadUnit,uploadSpeed:l.uploadSpeed,uploadUnit:l.uploadUnit,location:l.location??{city:"",country:""},latency:l.latency??"",latencyUnit:l.latencyUnit,loss:l.loss??"",lossUnit:l.lossUnit};let t;switch(process.platform){case"darwin":t=(0,child_process_1.execSync)(`osascript -e "tell application (path to frontmost application as text)
set exportFolder to choose file name with prompt \\"Save the MLab's Speed Test as:\\"
POSIX path of exportFolder
end"`).toString().trim();break}if(t){fs.writeFileSync(t,JSON.stringify(a,null,"	"));return}throw new Error(`Platform ${process.platform} not supported`)},FixedSpacer=({size:l})=>react_1.default.createElement(react_1.default.Fragment,null," ".repeat(l)),ErrorMessage=({text:l})=>react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,{bold:!0,color:"red"},"\u203A",react_1.default.createElement(FixedSpacer,{size:1})),react_1.default.createElement(ink_1.Text,{dimColor:!0},l)),initialState={privacyPolicyAccepted:!1,running:!1,isDone:!1,downloadSpeed:"0",downloadUnit:"Mb/s",downloadCompleted:!1,downloadProgress:0,uploadSpeed:"0",uploadUnit:"Mb/s",uploadCompleted:!1,uploadProgress:0,latencyUnit:"ms",lossUnit:"%"},MLab=({speedTest:l,options:a})=>{const[t,r]=(0,react_1.useState)({...initialState,privacyPolicyAccepted:a.acceptPrivacyPolicy,running:a.acceptPrivacyPolicy&&a.autostart}),[u,d]=(0,react_1.useState)(""),[c,f]=(0,react_1.useState)(""),{exit:m}=(0,ink_1.useApp)();if((0,ink_1.useInput)(async(e,n)=>{if(u){if(e==="r"&&!await isOffline()){d("");return}}else if(c){if(e==="b"){f("");return}}else if((n.delete||t.privacyPolicyAccepted&&n.return)&&(r(o=>({...initialState,privacyPolicyAccepted:o.privacyPolicyAccepted,running:!1})),await l.stop()),t.privacyPolicyAccepted&&n.return&&(r(o=>({...initialState,privacyPolicyAccepted:o.privacyPolicyAccepted,running:!0})),l.run()),n.ctrl&&e==="q"&&(await l.stop(),m()),e==="a"&&r(o=>({...o,privacyPolicyAccepted:!o.privacyPolicyAccepted})),t.isDone&&n.ctrl&&e==="s")try{exportSpeedTestResults(t)}catch{f("JSON data cannot be exported!")}}),(0,react_1.useEffect)(()=>(l.on("error",async e=>{d(await isOffline()?"Please check your internet connection":`Something happened: "${e.toString()}"`),r(n=>({...initialState,privacyPolicyAccepted:n.privacyPolicyAccepted}))}),l.on("server-chosen",e=>{r(n=>({...n,isDone:!1,location:{...e.location}}))}),l.on("download-start",()=>{r(e=>({...e,isDone:!1,downloadSpeed:"0",downloadUnit:"Mb/s"}))}),l.on("download-measurement",e=>{e.Source==="client"&&r(n=>({...n,downloadSpeed:e.Data.MeanClientMbps.toFixed(2),downloadProgress:e.Data.ElapsedTime>TIME_EXPECTED?1:e.Data.ElapsedTime/TIME_EXPECTED}))}),l.on("download-complete",e=>{r(n=>({...n,downloadSpeed:e.LastClientMeasurement?e.LastClientMeasurement.MeanClientMbps.toFixed(2):"0",downloadProgress:1,downloadCompleted:!0,latency:e.LastServerMeasurement?(e.LastServerMeasurement.TCPInfo.MinRTT/1e3).toFixed(0):void 0,loss:e.LastServerMeasurement?(e.LastServerMeasurement.TCPInfo.BytesRetrans/e.LastServerMeasurement.TCPInfo.BytesSent*100).toFixed(2):void 0}))}),l.on("upload-start",()=>{r(e=>({...e,uploadSpeed:"0",uploadUnit:"Mb/s"}))}),l.on("upload-measurement",e=>{e.Source==="server"&&r(n=>({...n,uploadSpeed:(e.Data.TCPInfo.BytesReceived/e.Data.TCPInfo.ElapsedTime*8).toFixed(2)})),e.Source==="client"&&r(n=>({...n,uploadProgress:e.Data.ElapsedTime>TIME_EXPECTED?1:e.Data.ElapsedTime/TIME_EXPECTED}))}),l.on("upload-complete",e=>{r(n=>({...n,uploadSpeed:e.LastServerMeasurement?(e.LastServerMeasurement.TCPInfo.BytesReceived/e.LastServerMeasurement.TCPInfo.ElapsedTime*8).toFixed(2):"0",uploadProgress:1,uploadCompleted:!0}))}),l.on("complete",()=>{r(e=>({...e,isDone:!0,running:!1}))}),()=>{l.removeAllListeners()}),[m]),a.json)return c||u?react_1.default.createElement(ink_1.Text,null,JSON.stringify({error:c||u},null,a.pretty?"	":"")):react_1.default.createElement(ink_1.Text,null,JSON.stringify(t,null,a.pretty?"	":""));const p=t.downloadCompleted?"green":"cyan",E=t.uploadCompleted?"green":"cyan",y=t.privacyPolicyAccepted?"green":"red",i=[];u?i.push(react_1.default.createElement(ink_1.Text,{key:"retry"},"Retry (r)")):c?i.push(react_1.default.createElement(ink_1.Text,{key:"back"},"Go Back (b)")):(t.privacyPolicyAccepted&&i.push(react_1.default.createElement(ink_1.Text,{key:"run"},t.running?"Restart":"Run"," (enter)")),t.running&&i.push(react_1.default.createElement(ink_1.Text,{key:"stop"},"Stop (delete)")),t.isDone&&i.push(react_1.default.createElement(ink_1.Text,{key:"export"},"Export JSON (ctrl + s)")));const s=[];return i.forEach((e,n)=>{s.push(...n%2?[react_1.default.createElement(ink_1.Text,{key:`sep-${n}`}," - "),e]:[e])}),c||u?react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ErrorMessage,{text:c||u})),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),s)):react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4}))),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,{bold:!0},"M-Lab's Speed Test")),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4}))),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,{color:y},t.privacyPolicyAccepted?"\u22A0":"\u2311"," "),react_1.default.createElement(ink_link_1.default,{url:"https://www.measurementlab.net/privacy/"},"Privacy Policy")),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4}))),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,"Test Server: ",t.location?`\u{1F5A5}  ${t.location.city}, ${t.location.country}`:"-")),react_1.default.createElement(ink_1.Box,null,t.running&&react_1.default.createElement(react_1.default.Fragment,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:2})),react_1.default.createElement(ink_1.Text,{color:"cyan"},react_1.default.createElement(ink_spinner_1.default,null)),react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:1}))),!t.running&&react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,{color:p},t.running||t.isDone?t.downloadSpeed:"-"," ",react_1.default.createElement(ink_1.Text,{dimColor:!0},t.downloadUnit," \u2193")),react_1.default.createElement(ink_1.Text,null," / "),react_1.default.createElement(ink_1.Text,{color:E},t.running||t.isDone?t.uploadSpeed:"-"," ",react_1.default.createElement(ink_1.Text,{dimColor:!0},t.uploadUnit," \u2191"))),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,"Latency: ",t.latency??"-"," ",t.latencyUnit)),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,"Loss: ",t.loss??"- ",t.lossUnit)),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4}))),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),s),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4})),react_1.default.createElement(ink_1.Text,null,t.privacyPolicyAccepted?"Decline":"Accept"," Privacy Policy (a) - Quit (ctrl + q)")),react_1.default.createElement(ink_1.Box,null,react_1.default.createElement(ink_1.Text,null,react_1.default.createElement(FixedSpacer,{size:4}))))};exports.MLab=MLab;