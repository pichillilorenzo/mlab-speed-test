"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MLabSpeedTest=void 0;const tslib_1=require("tslib"),puppeteer=tslib_1.__importStar(require("puppeteer")),events_1=tslib_1.__importDefault(require("events"));class MLabSpeedTest extends events_1.default{browser;_running=!1;constructor(){super()}get running(){return this._running}async init(){this._running=!1,this.browser=await puppeteer.launch();const t=await this.browser.newPage();await t.exposeFunction("onServerChosen",e=>{this.emit("server-chosen",e)}),await t.exposeFunction("onDownloadStart",e=>{this.emit("download-start",e)}),await t.exposeFunction("onDownloadMeasurement",e=>{this.emit("download-measurement",e)}),await t.exposeFunction("onDownloadComplete",e=>{this.emit("download-complete",e)}),await t.exposeFunction("onUploadStart",e=>{this.emit("upload-start",e)}),await t.exposeFunction("onUploadMeasurement",e=>{this.emit("upload-measurement",e)}),await t.exposeFunction("onUploadComplete",e=>{this.emit("upload-complete",e)}),await t.exposeFunction("onComplete",()=>{this.emit("complete")}),await t.goto("https://speed.measurementlab.net/",{waitUntil:"networkidle2"})}run=async()=>{if(this._running)return;const t=this.browser;if(!t)return;const e=(await t.pages())[1];!e||(this._running=!0,await e.evaluate(async()=>{await window.ndt7.test({userAcceptedDataPolicy:!0,uploadworkerfile:"/libraries/ndt7-upload-worker.min.js",downloadworkerfile:"/libraries/ndt7-download-worker.min.js"},{serverChosen:o=>{window.onServerChosen(o)},downloadStart:o=>{window.onDownloadStart(o)},downloadMeasurement:o=>{window.onDownloadMeasurement(o)},downloadComplete:o=>{window.onDownloadComplete(o)},uploadStart:o=>{window.onUploadStart(o)},uploadMeasurement:o=>{window.onUploadMeasurement(o)},uploadComplete:o=>{window.onUploadComplete(o)}}),window.onComplete()}).catch(o=>{}),this._running=!1)};async stop(){const t=this.browser;if(!t)return;const e=(await t.pages())[1];e&&await e.reload({waitUntil:"networkidle2"}),this._running=!1}async close(){const t=this.browser;!t||(await t.close(),this.browser=void 0,this._running=!1)}}exports.MLabSpeedTest=MLabSpeedTest;